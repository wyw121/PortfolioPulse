#!/bin/sh
#
# Git Pre-commit Hook - æ–‡æ¡£è‡ªåŠ¨åŒæ­¥
# åœ¨æäº¤å‰æ£€æŸ¥å¹¶æ›´æ–° .github æŒ‡ä»¤æ–‡ä»¶
#
# å®‰è£…æ–¹æ³•:
# cp scripts/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

echo "ğŸ” æ£€æŸ¥æ–‡æ¡£åŒæ­¥çŠ¶æ€..."

# æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®ç»“æ„å˜åŒ–
has_frontend_changes=false
has_backend_changes=false

# æ£€æŸ¥æ˜¯å¦æœ‰å‰ç«¯æ–‡ä»¶å˜åŒ–
if git diff --cached --name-only | grep -q "^frontend"; then
    has_frontend_changes=true
fi

if git diff --cached --name-only | grep -q "^frontend-vite"; then
    has_frontend_changes=true
fi

# æ£€æŸ¥æ˜¯å¦æœ‰åç«¯æ–‡ä»¶å˜åŒ–
if git diff --cached --name-only | grep -q "^backend"; then
    has_backend_changes=true
fi

# æ£€æŸ¥ .github æŒ‡ä»¤æ–‡ä»¶æ˜¯å¦éœ€è¦æ›´æ–°
should_update_docs=false

if [ "$has_frontend_changes" = true ]; then
    echo "ğŸ“ æ£€æµ‹åˆ°å‰ç«¯ä»£ç å˜åŒ–"
    should_update_docs=true
fi

if [ "$has_backend_changes" = true ]; then
    echo "ğŸ“ æ£€æµ‹åˆ°åç«¯ä»£ç å˜åŒ–"
    should_update_docs=true
fi

# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ˜¯æœ€æ–°çš„
check_instruction_freshness() {
    local instruction_file=".github/instructions/$1"
    local related_pattern="$2"
    
    if [ -f "$instruction_file" ]; then
        # æ£€æŸ¥æŒ‡ä»¤æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æ˜¯å¦æ™šäºç›¸å…³ä»£ç æ–‡ä»¶
        local instruction_time=$(stat -f %m "$instruction_file" 2>/dev/null || stat -c %Y "$instruction_file" 2>/dev/null)
        local latest_code_time=0
        
        # æŸ¥æ‰¾ç›¸å…³ä»£ç æ–‡ä»¶çš„æœ€æ–°ä¿®æ”¹æ—¶é—´
        for file in $(find . -path "./$related_pattern" -type f -newer "$instruction_file" 2>/dev/null | head -5); do
            local file_time=$(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file" 2>/dev/null)
            if [ "$file_time" -gt "$latest_code_time" ]; then
                latest_code_time=$file_time
            fi
        done
        
        if [ "$latest_code_time" -gt "$instruction_time" ]; then
            echo "âš ï¸ æŒ‡ä»¤æ–‡ä»¶ $instruction_file å¯èƒ½éœ€è¦æ›´æ–°"
            should_update_docs=true
        fi
    fi
}

# æ£€æŸ¥å„ä¸ªæŒ‡ä»¤æ–‡ä»¶çš„æ–°é²œåº¦
check_instruction_freshness "frontend-development.instructions.md" "frontend-vite/**/*"
check_instruction_freshness "backend-development.instructions.md" "backend/**/*"
check_instruction_freshness "ui-style-system.instructions.md" "frontend-vite/src/styles/**/*"

# å¦‚æœéœ€è¦æ›´æ–°æ–‡æ¡£ï¼Œè¿è¡ŒåŒæ­¥è„šæœ¬
if [ "$should_update_docs" = true ]; then
    echo "ğŸ”„ è¿è¡Œæ–‡æ¡£åŒæ­¥..."
    
    if [ -f "scripts/sync-docs.js" ]; then
        node scripts/sync-docs.js
        sync_result=$?
        
        if [ $sync_result -eq 0 ]; then
            echo "âœ… æ–‡æ¡£åŒæ­¥å®Œæˆ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡æ¡£å˜åŒ–éœ€è¦æ·»åŠ åˆ°æäº¤
            if git diff --name-only | grep -q "^\.github/"; then
                echo "ğŸ“‹ å‘ç°æ–‡æ¡£æ›´æ–°ï¼Œè¯·æ£€æŸ¥å¹¶æ·»åŠ åˆ°æäº¤:"
                git diff --name-only | grep "^\.github/" | sed 's/^/  - /'
                echo ""
                echo "å»ºè®®è¿è¡Œ: git add .github/"
                echo ""
                read -p "æ˜¯å¦è‡ªåŠ¨æ·»åŠ æ–‡æ¡£æ›´æ”¹åˆ°æ­¤æ¬¡æäº¤? (y/N): " auto_add
                if [ "$auto_add" = "y" ] || [ "$auto_add" = "Y" ]; then
                    git add .github/
                    echo "âœ… æ–‡æ¡£æ›´æ”¹å·²æ·»åŠ åˆ°æäº¤"
                fi
            fi
        else
            echo "âŒ æ–‡æ¡£åŒæ­¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            exit 1
        fi
    else
        echo "âš ï¸ æ‰¾ä¸åˆ°æ–‡æ¡£åŒæ­¥è„šæœ¬ï¼Œè·³è¿‡è‡ªåŠ¨åŒæ­¥"
    fi
fi

# éªŒè¯ Copilot æŒ‡ä»¤æ–‡ä»¶çš„åŸºæœ¬æ ¼å¼
validate_instruction_files() {
    echo "âœ… éªŒè¯æŒ‡ä»¤æ–‡ä»¶æ ¼å¼..."
    
    for instruction_file in .github/instructions/*.instructions.md; do
        if [ -f "$instruction_file" ]; then
            # æ£€æŸ¥æ˜¯å¦åŒ…å« applyTo é…ç½®
            if ! grep -q "^applyTo:" "$instruction_file"; then
                echo "âŒ $instruction_file ç¼ºå°‘ applyTo é…ç½®"
                exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«åŸºæœ¬å†…å®¹
            if [ "$(wc -l < "$instruction_file")" -lt 10 ]; then
                echo "âš ï¸ $instruction_file å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½ä¸å®Œæ•´"
            fi
        fi
    done
}

validate_instruction_files

echo "ğŸ‰ æ–‡æ¡£çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­æäº¤"
exit 0
