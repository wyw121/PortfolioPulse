name: ğŸš€ Build and Deploy PortfolioPulse

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "18"
  RUST_VERSION: "1.75"

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: portfolio_pulse_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Frontend Lint & Type Check
        working-directory: ./frontend
        run: |
          npm run lint
          npm run type-check

      - name: ğŸ—ï¸ Frontend Build
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000

      - name: ğŸ§ª Frontend Tests
        working-directory: ./frontend
        run: npm run test

      - name: ğŸ¦€ Backend Build
        working-directory: ./backend
        run: cargo build --verbose

      - name: ğŸ§ª Backend Tests
        working-directory: ./backend
        run: cargo test --verbose
        env:
          DATABASE_URL: mysql://root:password@localhost:3306/portfolio_pulse_test

      - name: ğŸ” Backend Lint (Clippy)
        working-directory: ./backend
        run: cargo clippy -- -D warnings

  build-docker:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    outputs:
      frontend-image: ${{ steps.meta.outputs.frontend-image }}
      backend-image: ${{ steps.meta.outputs.backend-image }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Extract Metadata
        id: meta
        run: |
          echo "frontend-image=portfoliopulse-frontend:$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "backend-image=portfoliopulse-backend:$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          tags: ${{ steps.meta.outputs.frontend-image }}
          outputs: type=docker,dest=/tmp/frontend-image.tar

      - name: ğŸ—ï¸ Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          tags: ${{ steps.meta.outputs.backend-image }}
          outputs: type=docker,dest=/tmp/backend-image.tar

      - name: ğŸ“¤ Upload Frontend Image
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: /tmp/frontend-image.tar

      - name: ğŸ“¤ Upload Backend Image
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: /tmp/backend-image.tar

  build-binary:
    name: âš™ï¸ Build Binary Files
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: ğŸ—ï¸ Build Frontend Static Files
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: http://localhost:8000

      - name: ğŸ—ï¸ Build Backend Binary
        working-directory: ./backend
        run: |
          cargo build --release
          strip target/release/portfolio_pulse

      - name: ğŸ“¦ Create Deployment Package
        run: |
          mkdir -p deploy/

          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          cp -r frontend/.next/static deploy/frontend-static/
          cp -r frontend/public deploy/frontend-public/

          # å¤åˆ¶åç«¯äºŒè¿›åˆ¶æ–‡ä»¶
          cp backend/target/release/portfolio_pulse deploy/
          cp backend/Cargo.toml deploy/
          cp -r backend/migrations deploy/ 2>/dev/null || true

          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp .env.example deploy/.env
          cp README.md deploy/

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > deploy/start.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ğŸš€ Starting PortfolioPulse..."

          # Set environment variables
          export NODE_ENV=production
          export DATABASE_URL="${DATABASE_URL:-mysql://portfoliopulse:password@localhost:3306/portfolio_pulse}"

          # Run database migrations if available
          if [ -d "migrations" ]; then
            echo "ğŸ”„ Running database migrations..."
            # Note: You need diesel CLI installed on the server
            # diesel migration run
          fi

          # Start backend service
          echo "ğŸ¦€ Starting backend service..."
          ./portfolio_pulse
          EOF

          chmod +x deploy/start.sh

          # åˆ›å»ºéƒ¨ç½²è¯´æ˜
          cat > deploy/DEPLOY.md << 'EOF'
          # éƒ¨ç½²è¯´æ˜

          ## å¿«é€Ÿéƒ¨ç½²
          1. ä¸Šä¼ æ­¤ç›®å½•åˆ°æœåŠ¡å™¨
          2. å®‰è£… MySQL 8.0+
          3. é…ç½® .env æ–‡ä»¶
          4. è¿è¡Œ ./start.sh

          ## å‰ç«¯éƒ¨ç½²
          - ä½¿ç”¨ Nginx æˆ–å…¶ä»– Web æœåŠ¡å™¨æ‰˜ç®¡ frontend-static/ å’Œ frontend-public/
          - é…ç½®åå‘ä»£ç†åˆ°åç«¯æœåŠ¡ (ç«¯å£ 8000)

          ## å¥åº·æ£€æŸ¥
          - åç«¯: http://localhost:8000/api/health
          EOF

      - name: ğŸ“¤ Upload Binary Package
        uses: actions/upload-artifact@v4
        with:
          name: binary-package
          path: deploy/

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-docker, build-binary]
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-image
          path: /tmp/

      - name: ğŸ“¥ Download Backend Image
        uses: actions/download-artifact@v4
        with:
          name: backend-image
          path: /tmp/

      - name: ğŸš€ Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/portfoliopulse-staging

            # åœæ­¢ç°æœ‰æœåŠ¡
            docker-compose down || true

            # æ¸…ç†æ—§é•œåƒ
            docker system prune -f

            # ç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ
            echo "å‡†å¤‡éƒ¨ç½²åˆ° Staging ç¯å¢ƒ..."

  deploy-production:
    name: ğŸ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-docker, build-binary]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ğŸ“¥ Download Binary Package
        uses: actions/download-artifact@v4
        with:
          name: binary-package
          path: ./deploy

      - name: ğŸ¯ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # åˆ›å»ºå¤‡ä»½
            if [ -d "/opt/portfoliopulse/current" ]; then
              cp -r /opt/portfoliopulse/current /opt/portfoliopulse/backup-$(date +%Y%m%d-%H%M%S)
            fi

            # åˆ›å»ºç›®å½•
            mkdir -p /opt/portfoliopulse/current

            echo "âœ… Production deployment completed!"
            echo "ğŸŒ Backend API: http://${{ secrets.PRODUCTION_HOST }}:8000"

      - name: ğŸ“¤ Upload Deployment Package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "deploy/*"
          target: "/opt/portfoliopulse/current/"
          strip_components: 1

      - name: ğŸ”„ Restart Production Service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/portfoliopulse/current

            # åœæ­¢æ—§æœåŠ¡
            pkill -f portfolio_pulse || true

            # å¯åŠ¨æ–°æœåŠ¡
            nohup ./start.sh > service.log 2>&1 &

            # éªŒè¯æœåŠ¡å¯åŠ¨
            sleep 10
            if curl -f http://localhost:8000/api/health; then
              echo "âœ… Service started successfully!"
            else
              echo "âŒ Service failed to start"
              exit 1
            fi

  notification:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: ğŸ“§ Notify Success
        if: needs.deploy-production.result == 'success'
        run: |
          echo "ğŸ‰ PortfolioPulse deployed successfully!"
          # è¿™é‡Œå¯ä»¥é›†æˆ Slack, Discord, é‚®ä»¶ç­‰é€šçŸ¥æœåŠ¡

      - name: ğŸš¨ Notify Failure
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "âŒ PortfolioPulse deployment failed!"
          # å‘é€å¤±è´¥é€šçŸ¥
